<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Dados - TechStyle</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">üõçÔ∏è TechStyle</div>
                <nav>
                    <ul>
                        <li><a href="home.html">In√≠cio</a></li>
                        <li><a href="#produtos">Produtos</a></li>
                        <li><a href="dados.html" class="active">Meus Dados</a></li>
                        <li><a href="#" id="logout-btn">Sair</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="page-header">
            <h1>Meus Dados</h1>
            <p>Gerencie suas informa√ß√µes pessoais</p>
        </div>

        <div id="user-message" class="message" style="display: none;"></div>

        <div class="profile-container">
            <!-- Card Informa√ß√µes Pessoais -->
            <div class="data-card">
                <div class="card-header">
                    <h2>üìã Informa√ß√µes Pessoais</h2>
                </div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="full_name">Nome Completo</label>
                            <input type="text" id="full_name" name="full_name" placeholder="Seu nome completo">
                        </div>

                        <div class="form-group">
                            <label for="email">E-mail</label>
                            <input type="email" id="email" name="email" readonly class="readonly">
                            <small>E-mail n√£o pode ser alterado</small>
                        </div>

                        <div class="form-group">
                            <label for="phone">Telefone</label>
                            <input type="tel" id="phone" name="phone" placeholder="(11) 99999-9999">
                        </div>

                        <div class="form-group">
                            <label for="cpf">CPF</label>
                            <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00">
                        </div>

                        <div class="form-group">
                            <label for="birth_date">Data de Nascimento</label>
                            <input type="date" id="birth_date" name="birth_date">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Endere√ßo -->
            <div class="data-card">
                <div class="card-header">
                    <h2>üè† Endere√ßo</h2>
                </div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="address_zipcode">CEP</label>
                            <input type="text" id="address_zipcode" name="address_zipcode" placeholder="00000-000">
                        </div>

                        <div class="form-group full-width">
                            <label for="address_street">Rua</label>
                            <input type="text" id="address_street" name="address_street" placeholder="Nome da rua">
                        </div>

                        <div class="form-group">
                            <label for="address_number">N√∫mero</label>
                            <input type="text" id="address_number" name="address_number" placeholder="123">
                        </div>

                        <div class="form-group">
                            <label for="address_complement">Complemento</label>
                            <input type="text" id="address_complement" name="address_complement" placeholder="Apto 45">
                        </div>

                        <div class="form-group">
                            <label for="address_neighborhood">Bairro</label>
                            <input type="text" id="address_neighborhood" name="address_neighborhood" placeholder="Centro">
                        </div>

                        <div class="form-group">
                            <label for="address_city">Cidade</label>
                            <input type="text" id="address_city" name="address_city" placeholder="S√£o Paulo">
                        </div>

                        <div class="form-group">
                            <label for="address_state">Estado</label>
                            <select id="address_state" name="address_state">
                                <option value="">Selecione</option>
                                <option value="SP">S√£o Paulo</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="ES">Esp√≠rito Santo</option>
                                <option value="PR">Paran√°</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <!-- Outros estados... -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- A√ß√µes -->
            <div class="actions-card">
                <button type="button" id="save-btn" class="btn-primary large">
                    üíæ Salvar Altera√ß√µes
                </button>
                <button type="button" id="cancel-btn" class="btn-secondary">
                    Cancelar
                </button>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>TechStyle</h3>
                    <p>A melhor loja virtual de tecnologia e estilo de vida.</p>
                </div>
                <div class="footer-section">
                    <h3>Links R√°pidos</h3>
                    <ul>
                        <li><a href="home.html">In√≠cio</a></li>
                        <li><a href="#produtos">Produtos</a></li>
                        <li><a href="dados.html">Meus Dados</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contato</h3>
                    <ul>
                        <li>Email: contato@techstyle.com</li>
                        <li>Telefone: (11) 9999-9999</li>
                        <li>Endere√ßo: S√£o Paulo, SP</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 TechStyle. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <script src="auth.js"></script>
    <script>
        // Fun√ß√µes espec√≠ficas para a p√°gina de dados - Vers√£o Simplificada
        document.addEventListener('DOMContentLoaded', function() {
            let currentUser = null;

            // Inicializar
            initializePage();

            async function initializePage() {
                await checkAuthentication();
                await loadUserData();
                setupEventListeners();
            }

            async function checkAuthentication() {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }
                currentUser = session.user;
            }

            async function loadUserData() {
                // Email do usu√°rio
                document.getElementById('email').value = currentUser.email;
                
                // Carregar perfil
                const { data: profile } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (profile) {
                    fillForm(profile);
                }
            }

            function fillForm(profile) {
                const fields = [
                    'full_name', 'phone', 'cpf', 'birth_date',
                    'address_street', 'address_number', 'address_complement',
                    'address_neighborhood', 'address_city', 'address_state', 'address_zipcode'
                ];
                
                fields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element && profile[field]) {
                        element.value = profile[field];
                    }
                });
            }

            function setupEventListeners() {
                // Formata√ß√£o de campos
                setupFieldMask('cpf', '000.000.000-00');
                setupFieldMask('phone', '(00) 00000-0000');
                setupFieldMask('address_zipcode', '00000-000');

                // Bot√£o salvar
                document.getElementById('save-btn').addEventListener('click', saveData);
                
                // Bot√£o cancelar
                document.getElementById('cancel-btn').addEventListener('click', () => {
                    window.location.href = 'home.html';
                });
            }

            function setupFieldMask(fieldId, mask) {
                const field = document.getElementById(fieldId);
                if (!field) return;

                field.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    let maskedValue = '';
                    
                    for (let i = 0, j = 0; i < mask.length && j < value.length; i++) {
                        if (mask[i] === '0') {
                            maskedValue += value[j++];
                        } else {
                            maskedValue += mask[i];
                        }
                    }
                    
                    e.target.value = maskedValue;
                });
            }

            async function saveData() {
                const saveBtn = document.getElementById('save-btn');
                const originalText = saveBtn.innerHTML;
                
                try {
                    saveBtn.innerHTML = '‚è≥ Salvando...';
                    saveBtn.disabled = true;

                    const formData = getFormData();
                    await saveProfile(formData);
                    
                    showMessage('Dados salvos com sucesso!', 'success');
                    
                } catch (error) {
                    showMessage('Erro ao salvar: ' + error.message, 'error');
                } finally {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }

            function getFormData() {
                const data = {};
                const fields = [
                    'full_name', 'phone', 'cpf', 'birth_date',
                    'address_street', 'address_number', 'address_complement',
                    'address_neighborhood', 'address_city', 'address_state', 'address_zipcode'
                ];
                
                fields.forEach(field => {
                    const element = document.getElementById(field);
                    data[field] = element ? element.value : '';
                });
                
                return data;
            }

            async function saveProfile(data) {
                const profileData = {
                    user_id: currentUser.id,
                    ...data,
                    updated_at: new Date().toISOString()
                };

                // Verificar se existe
                const { data: existing } = await supabase
                    .from('user_profiles')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .single();

                let error;
                if (existing) {
                    // Update
                    const { error: updateError } = await supabase
                        .from('user_profiles')
                        .update(profileData)
                        .eq('user_id', currentUser.id);
                    error = updateError;
                } else {
                    // Insert
                    const { error: insertError } = await supabase
                        .from('user_profiles')
                        .insert([profileData]);
                    error = insertError;
                }

                if (error) throw error;
            }

            function showMessage(text, type) {
                const messageEl = document.getElementById('user-message');
                messageEl.textContent = text;
                messageEl.className = `message ${type}`;
                messageEl.style.display = 'block';
                
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 4000);
            }
        });
    </script>
</body>
</html>