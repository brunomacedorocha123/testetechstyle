<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Dados - TechStyle</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">üõçÔ∏è TechStyle</div>
                <nav>
                    <ul>
                        <li><a href="home.html">In√≠cio</a></li>
                        <li><a href="#produtos">Produtos</a></li>
                        <li><a href="dados.html" class="active">Meus Dados</a></li>
                        <li><a href="#" id="logout-btn">Sair</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="profile-section">
            <h1>Meus Dados Pessoais</h1>
            
            <div id="user-message" class="message" style="display: none;"></div>

            <form id="profile-form" class="profile-form">
                <div class="form-section">
                    <h2>Informa√ß√µes Pessoais</h2>
                    
                    <div class="form-group">
                        <label for="full_name">Nome Completo *</label>
                        <input type="text" id="full_name" name="full_name" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">E-mail</label>
                            <input type="email" id="email" name="email" readonly>
                            <small>O e-mail n√£o pode ser alterado</small>
                        </div>

                        <div class="form-group">
                            <label for="phone">Telefone</label>
                            <input type="tel" id="phone" name="phone" placeholder="(11) 99999-9999">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cpf">CPF</label>
                            <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" maxlength="14">
                        </div>

                        <div class="form-group">
                            <label for="birth_date">Data de Nascimento</label>
                            <input type="date" id="birth_date" name="birth_date">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Endere√ßo</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="address_zipcode">CEP</label>
                            <input type="text" id="address_zipcode" name="address_zipcode" placeholder="00000-000" maxlength="9">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="address_street">Rua</label>
                            <input type="text" id="address_street" name="address_street">
                        </div>

                        <div class="form-group">
                            <label for="address_number">N√∫mero</label>
                            <input type="text" id="address_number" name="address_number">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="address_complement">Complemento</label>
                        <input type="text" id="address_complement" name="address_complement">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="address_neighborhood">Bairro</label>
                            <input type="text" id="address_neighborhood" name="address_neighborhood">
                        </div>

                        <div class="form-group">
                            <label for="address_city">Cidade</label>
                            <input type="text" id="address_city" name="address_city">
                        </div>

                        <div class="form-group">
                            <label for="address_state">Estado</label>
                            <select id="address_state" name="address_state">
                                <option value="">Selecione</option>
                                <option value="AC">Acre</option>
                                <option value="AL">Alagoas</option>
                                <option value="AP">Amap√°</option>
                                <option value="AM">Amazonas</option>
                                <option value="BA">Bahia</option>
                                <option value="CE">Cear√°</option>
                                <option value="DF">Distrito Federal</option>
                                <option value="ES">Esp√≠rito Santo</option>
                                <option value="GO">Goi√°s</option>
                                <option value="MA">Maranh√£o</option>
                                <option value="MT">Mato Grosso</option>
                                <option value="MS">Mato Grosso do Sul</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="PA">Par√°</option>
                                <option value="PB">Para√≠ba</option>
                                <option value="PR">Paran√°</option>
                                <option value="PE">Pernambuco</option>
                                <option value="PI">Piau√≠</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="RN">Rio Grande do Norte</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <option value="RO">Rond√¥nia</option>
                                <option value="RR">Roraima</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="SP">S√£o Paulo</option>
                                <option value="SE">Sergipe</option>
                                <option value="TO">Tocantins</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Salvar Altera√ß√µes</button>
                    <button type="button" id="cancel-btn" class="btn-secondary">Cancelar</button>
                </div>
            </form>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>TechStyle</h3>
                    <p>A melhor loja virtual de tecnologia e estilo de vida.</p>
                </div>
                <div class="footer-section">
                    <h3>Links R√°pidos</h3>
                    <ul>
                        <li><a href="home.html">In√≠cio</a></li>
                        <li><a href="#produtos">Produtos</a></li>
                        <li><a href="dados.html">Meus Dados</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contato</h3>
                    <ul>
                        <li>Email: contato@techstyle.com</li>
                        <li>Telefone: (11) 9999-9999</li>
                        <li>Endere√ßo: S√£o Paulo, SP</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 TechStyle. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <script src="auth.js"></script>
    <script>
        // Fun√ß√µes espec√≠ficas para a p√°gina de dados
        document.addEventListener('DOMContentLoaded', function() {
            let currentUser = null;

            // Carregar dados do usu√°rio
            async function loadUserData() {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    
                    if (!session) {
                        window.location.href = 'login.html';
                        return;
                    }

                    currentUser = session.user;
                    
                    // Preencher email (n√£o edit√°vel)
                    document.getElementById('email').value = currentUser.email;
                    
                    // Carregar dados do perfil
                    await loadUserProfile();
                    
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    showMessage('Erro ao carregar dados do usu√°rio', 'error');
                }
            }

            // Carregar perfil do usu√°rio
            async function loadUserProfile() {
                try {
                    const { data: profile, error } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .single();

                    if (error && error.code !== 'PGRST116') {
                        console.error('Erro ao buscar perfil:', error);
                        return;
                    }

                    // Preencher formul√°rio com dados existentes
                    if (profile) {
                        document.getElementById('full_name').value = profile.full_name || '';
                        document.getElementById('phone').value = profile.phone || '';
                        document.getElementById('cpf').value = profile.cpf || '';
                        document.getElementById('birth_date').value = profile.birth_date || '';
                        document.getElementById('address_street').value = profile.address_street || '';
                        document.getElementById('address_number').value = profile.address_number || '';
                        document.getElementById('address_complement').value = profile.address_complement || '';
                        document.getElementById('address_neighborhood').value = profile.address_neighborhood || '';
                        document.getElementById('address_city').value = profile.address_city || '';
                        document.getElementById('address_state').value = profile.address_state || '';
                        document.getElementById('address_zipcode').value = profile.address_zipcode || '';
                    }

                } catch (error) {
                    console.error('Erro ao carregar perfil:', error);
                }
            }

            // Salvar dados do perfil
            async function saveUserProfile(formData) {
                try {
                    const profileData = {
                        user_id: currentUser.id,
                        full_name: formData.get('full_name'),
                        phone: formData.get('phone'),
                        cpf: formData.get('cpf'),
                        birth_date: formData.get('birth_date') || null,
                        address_street: formData.get('address_street'),
                        address_number: formData.get('address_number'),
                        address_complement: formData.get('address_complement'),
                        address_neighborhood: formData.get('address_neighborhood'),
                        address_city: formData.get('address_city'),
                        address_state: formData.get('address_state'),
                        address_zipcode: formData.get('address_zipcode'),
                        updated_at: new Date().toISOString()
                    };

                    // Verificar se perfil j√° existe
                    const { data: existingProfile } = await supabase
                        .from('user_profiles')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .single();

                    let error;
                    
                    if (existingProfile) {
                        // Atualizar perfil existente
                        const { error: updateError } = await supabase
                            .from('user_profiles')
                            .update(profileData)
                            .eq('user_id', currentUser.id);
                        error = updateError;
                    } else {
                        // Criar novo perfil
                        const { error: insertError } = await supabase
                            .from('user_profiles')
                            .insert([profileData]);
                        error = insertError;
                    }

                    if (error) {
                        throw error;
                    }

                    return true;
                    
                } catch (error) {
                    console.error('Erro ao salvar perfil:', error);
                    throw error;
                }
            }

            // Mostrar mensagens
            function showMessage(message, type = 'success') {
                const messageElement = document.getElementById('user-message');
                if (messageElement) {
                    messageElement.textContent = message;
                    messageElement.className = `message ${type}`;
                    messageElement.style.display = 'block';
                    
                    setTimeout(() => {
                        messageElement.style.display = 'none';
                    }, 5000);
                }
            }

            // Formatar CPF
            document.getElementById('cpf')?.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    value = value.replace(/(\d{3})(\d)/, '$1.$2')
                                .replace(/(\d{3})(\d)/, '$1.$2')
                                .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                }
                e.target.value = value;
            });

            // Formatar CEP
            document.getElementById('address_zipcode')?.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 8) {
                    value = value.replace(/(\d{5})(\d)/, '$1-$2');
                }
                e.target.value = value;
            });

            // Formatar Telefone
            document.getElementById('phone')?.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    value = value.replace(/(\d{2})(\d)/, '($1) $2')
                                .replace(/(\d{5})(\d)/, '$1-$2');
                }
                e.target.value = value;
            });

            // Submit do formul√°rio
            document.getElementById('profile-form')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                
                try {
                    submitButton.textContent = 'Salvando...';
                    submitButton.disabled = true;

                    await saveUserProfile(new FormData(this));
                    showMessage('Dados salvos com sucesso!', 'success');
                    
                } catch (error) {
                    showMessage('Erro ao salvar dados: ' + error.message, 'error');
                } finally {
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                }
            });

            // Bot√£o cancelar
            document.getElementById('cancel-btn')?.addEventListener('click', function() {
                window.location.href = 'home.html';
            });

            // Inicializar
            loadUserData();
        });
    </script>
</body>
</html>